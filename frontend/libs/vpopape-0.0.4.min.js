var Vpopape=function(t){Vpopape._insts.push(this),this._st={popupId:Vpopape._st.nextInstId++,eventHandlers:{},inProgress:!1,isShown:!1},this._initOptions(t),this._bindContext(),this._init()};Vpopape._insts=[],Vpopape._opts={classname:"vpopape",activeClassname:"vpopape_active",hidingClassname:!1},Vpopape._st={nextInstId:0,shownPopups:[],toHideOnEsc:[],toHideOnOutsideClick:[],toHideOnScroll:[]},Vpopape.getOptionDefault=function(t){if(t in Vpopape._opts)return Vpopape._opts[t]},Vpopape.setOptionDefault=function(t,e){Vpopape._opts[t]=e},Vpopape.getPopups=function(){var e=[];return Vpopape._insts.forEach(function(t){t&&e.push(t)}),e},Vpopape.getShown=function(){return Vpopape._st.shownPopups.map(function(t){return t})},Vpopape.getHidden=function(){var e=[];return Vpopape._insts.forEach(function(t){~Vpopape._st.shownPopups.indexOf(t)||e.push(t)}),e},Vpopape.prototype.getPopup=function(){return this._opts.popup},Vpopape.prototype.isInProgress=function(){return this._st.inProgress},Vpopape.prototype.isShown=function(){return this._st.isShown},Vpopape.prototype._bindContext=function(){this._callerHandler=this._callerHandler.bind(this),this._closerHandler=this._closerHandler.bind(this)},Vpopape.prototype._init=function(){this._opts.popup.classList.add(this._opts.classname),"none"===getComputedStyle(this._opts.popup).display?this._st.isShown=!1:this._opts.hidingClassname&&this._opts.popup.classList.contains(this._opts.hidingClassname)?this._st.isShown=!1:(this._st.isShown=!0,Vpopape._st.shownPopups.push(this),this._opts.popup.classList.add(this._opts.activeClassname),this._opts.dontHideOnOutsideClick||Vpopape._st.toHideOnOutsideClick.push(this),this._opts.hideOnEsc&&Vpopape._st.toHideOnEsc.push(this),this._opts.hideOnScroll&&Vpopape._st.toHideOnScroll.push(this)),Vpopape._setOnOutsideClickHandler(),Vpopape._setOnEscHandler(),Vpopape._setOnScrollHandler(),this._opts.callers&&this._setHandlersForCallersClosers("callers","add"),this._opts.closers&&this._setHandlersForCallersClosers("closers","add")},Vpopape.prototype.on=function(t,e){this._st.eventHandlers[t]||(this._st.eventHandlers[t]=[]),this._st.eventHandlers[t].push(e)},Vpopape.prototype.off=function(t,e){var s=this._st.eventHandlers[t];if(s)for(var o=0;o<s.length;o++)s[o]===e&&s.splice(o--,1)},Vpopape.prototype.trigger=function(t){var e=this._st.eventHandlers[t];if(e)for(var s=0;s<e.length;s++)e[s].apply(this,Array.prototype.slice.call(arguments,1))},Vpopape.prototype._setHandlersForCallersClosers=function(e,s){var t=this._opts[e];s+="EventListener",t&&t.length?Array.prototype.forEach.call(t,function(t){t instanceof HTMLElement&&t[s]("click","callers"===e?this._callerHandler:this._closerHandler)}.bind(this)):t instanceof HTMLElement&&t[s]("click","callers"===e?this._callerHandler:this._closerHandler)},Vpopape.prototype._callerHandler=function(t){t.preventDefault(),this.showPopup()},Vpopape.prototype._closerHandler=function(t){t.preventDefault(),this.hidePopup()},Vpopape.prototype.hidePopup=function(){var t=this;if(this._st.inProgress||!this._st.isShown)return!1;if((this._st.inProgress=!0,this._opts.beforeHide)&&!1===this._opts.beforeHide.call(this))return this.trigger("cancelHide"),this._st.inProgress=!1;return this.trigger("beforeHide"),this._opts.dontHideOnOutsideClick||Vpopape._st.toHideOnOutsideClick.splice(Vpopape._st.toHideOnOutsideClick.indexOf(this),1),this._opts.hideOnEsc&&Vpopape._st.toHideOnEsc.splice(Vpopape._st.toHideOnEsc.indexOf(this),1),this._opts.hideOnScroll&&Vpopape._st.toHideOnScroll.splice(Vpopape._st.toHideOnScroll.indexOf(this),1),Vpopape._st.shownPopups.splice(Vpopape._st.shownPopups.indexOf(this),1),this._opts.popup.classList.remove(this._opts.activeClassname),setTimeout(function(){t._opts.beforeAfterHide&&t._opts.beforeAfterHide.call(t),t.trigger("beforeAfterHide"),t._opts.hidingClassname?t._opts.popup.classList.add(t._opts.hidingClassname):t._opts.popup.style.display="none",t._opts.afterHide&&t._opts.afterHide.call(t),t.trigger("afterHide"),t._st.isShown=!1,t._st.inProgress=!1},this._opts.animationTime),!0},Vpopape._setOnOutsideClickHandler=function(){var i;Vpopape._st.onOutsideClickHandlerSetted||(Vpopape._st.onOutsideClickHandlerSetted=!0,document.addEventListener("touchstart",t),document.addEventListener("mousedown",t));function t(t){!i&&Vpopape._st.toHideOnOutsideClick.length&&(i=!0,~t.type.indexOf("touch")?(document.addEventListener("touchmove",e),document.addEventListener("touchend",s)):(document.addEventListener("mousemove",e),document.addEventListener("mouseup",s)))}function e(t){i=!1,n(t)}function s(t){i=!1,n(t);var e=t.target,s={};for(Vpopape._st.toHideOnOutsideClick.forEach(function(t){s[t._st.popupId]=t});1===e.nodeType;){for(var o in s)p(o);e=e.parentNode}for(o in s){if(!s[o]._st.isShown||s[o]._st.inProgress)return;s[o].hidePopup()}function p(t){s[t].getPopup()===e&&delete s[t]}}function n(t){~t.type.indexOf("touch")?(document.removeEventListener("touchmove",e),document.removeEventListener("touchend",s)):(document.removeEventListener("mousemove",e),document.removeEventListener("mouseup",s))}},Vpopape._setOnEscHandler=function(){Vpopape._st.onEscHandlerSetted||(Vpopape._st.onEscHandlerSetted=!0,window.addEventListener("keydown",function(t){if(27!==t.keyCode||!Vpopape._st.toHideOnEsc.length)return;var e;t.preventDefault(),Vpopape._st.toHideOnEsc.forEach(function(t){e?t._opts.hideOnEscPriority>=e._opts.hideOnEscPriority&&(e=t):e=t}),e.hidePopup()}))},Vpopape._setOnScrollHandler=function(){Vpopape._st.onScrollHandler||(Vpopape._st.onScrollHandler=!0,window.addEventListener("scroll",function(){Vpopape._st.toHideOnScroll.forEach(function(t){t.hidePopup()})}))},Vpopape.prototype._initOptions=function(e){e instanceof HTMLElement&&(e={popup:e}),this._opts={popup:e.popup,animationTime:e.animationTime||0,hideOnEscPriority:e.hideOnEscPriority||0,callers:e.callers||null,closers:e.closers||null,beforeShow:e.beforeShow||null,afterBeforeShow:e.afterBeforeShow||null,afterShow:e.afterShow||null,beforeHide:e.beforeHide||null,beforeAfterHide:e.beforeAfterHide||null,afterHide:e.afterHide||null,hideOnEsc:e.hideOnEsc||!1,hideOnScroll:e.hideOnScroll||!1,dontHideOnOutsideClick:e.dontHideOnOutsideClick||!1},["classname","activeClassname","hidingClassname"].forEach(function(t){this._opts[t]=void 0!==e[t]?e[t]:Vpopape._opts[t]},this)},Vpopape.prototype._updateHideLists=function(){if(!this._st.inProgress&&this._st.isShown){var t={toHideOnOutsideClick:!this._opts.dontHideOnOutsideClick,toHideOnEsc:this._opts.hideOnEsc,toHideOnScroll:this._opts.hideOnScroll};for(var e in t){var s=Vpopape._st[e].indexOf(this);!~s&&t[e]?Vpopape._st[e].push(this):~s&&!t[e]&&Vpopape._st[e].splice(s,1)}}},Vpopape.prototype.getOption=function(t){if(t in this._opts)return this._opts[t]},Vpopape.prototype.setOption=function(t,e){if(this._opts[t]!==e)switch(t){case"callers":return this._setHandlersForCallersClosers("callers","remove"),this._opts.callers=e,void this._setHandlersForCallersClosers("callers","add");case"closers":return this._setHandlersForCallersClosers("closers","remove"),this._opts.closers=e,void this._setHandlersForCallersClosers("closers","add");case"hidingClassname":return this._opts.hidingClassname=e,void(this._st.isShown||(this._opts.hidingClassname?this._opts.popup.classList.add(this._opts.hidingClassname):this._opts.popup.style.display="none"));case"dontHideOnOutsideClick":case"hideOnScroll":case"hideOnEsc":return this._opts[t]=e,void this._updateHideLists(this);default:this._opts[t]=e}},Vpopape.prototype.showPopup=function(){var t=this;if(this._st.inProgress||this._st.isShown)return!1;if((this._st.inProgress=!0,this._opts.beforeShow)&&!1===this._opts.beforeShow.call(this))return this.trigger("cancelShow"),this._st.inProgress=!1;return this.trigger("beforeShow"),this._opts.hidingClassname?this._opts.popup.classList.remove(this._opts.hidingClassname):this._opts.popup.style.display="block",this._opts.popup.offsetHeight,this._opts.popup.classList.add(this._opts.activeClassname),this._opts.afterBeforeShow&&this._opts.afterBeforeShow.call(this),this.trigger("afterBeforeShow"),Vpopape._st.shownPopups.push(this),setTimeout(function(){t._opts.dontHideOnOutsideClick||Vpopape._st.toHideOnOutsideClick.push(t),t._opts.hideOnEsc&&Vpopape._st.toHideOnEsc.push(t),t._opts.hideOnScroll&&Vpopape._st.toHideOnScroll.push(t),t._opts.afterShow&&t._opts.afterShow.call(t),t.trigger("afterShow"),t._st.isShown=!0,t._st.inProgress=!1},this._opts.animationTime),!0};export default Vpopape;